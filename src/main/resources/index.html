<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head lang="en">
    <meta charset="UTF-8">
    <title>TrafficLights manager</title>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.2.26/angular.min.js"></script>
    <link rel="stylesheet" href="traffic.css">
</head>
<body ng-app="" ng-controller="trafficLightsController">
<div class="car {{car}}"></div>
<button ng-click="toggleLights()">{{autoRefreshing? 'Stop' : 'Start'}}</button>
<div class="main" >
   <div class="row center"><div id="north-tf" class="tf {{lightColor[0]}}" >0</div></div>
   <div class="row"><div id="west-tf" class="tf west {{lightColor[3]}}">3</div><div id="east-tf" class="tf east {{lightColor[1]}}">1</div></div>
   <div class="row center"><div id="south-tf" class="tf {{lightColor[2]}}">2</div></div>
  </div>

</body>

<script>
function trafficLightsController($scope,$timeout,$http) {

    $scope.autoRefreshing = false;
    $scope.lightColor = new Array(4);
    $scope.toggleLights = function(){

        if($scope.autoRefreshing){
            $scope.autoRefreshing = false;
            for(var i=0;i < $scope.lightColor.length;i++ ) {
                $scope.lightColor[i] = null;
            }
            $scope.car = "";
            return;
        }
        $scope.autoRefreshing = true;
       callFnOnInterval(1000);
    };

    function callFnOnInterval( timeInterval) {
        if($scope.autoRefreshing) {
                $scope.updateTrafficLightsModel();
                $timeout(function () {
                    if($scope.autoRefreshing){callFnOnInterval(timeInterval);}
                }, timeInterval);
            }
    };

    $scope.updateTrafficLightsModel = function(){
        $http.get('/status').
                success(function (data, status, headers, config) {
                   var statuses =  data.status;
                   if(typeof statuses[0] !== undefined) {
                        var isGreen = false;
                       for (var i = 0; i < $scope.lightColor.length; i++) {
                           if (statuses[i] == "GreenLight") {
                               $scope.car = "from-" + i;
                               isGreen = true;
                           }
                           if(!isGreen) {
                               $scope.car = "";
                           }
                           $scope.lightColor[i] = statuses[i];
                       }
                   }
                });
    };
 }


</script>

</html>